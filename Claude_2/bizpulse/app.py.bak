import streamlit as st
import pandas as pd
import plotly.express as px
import plotly.graph_objects as go
from datetime import datetime

# Import utilities
from utils.data_loader import load_and_process_csv, aggregate_to_customers
from utils.segmentation import assign_segments, get_segment_summary, SEGMENT_DEFINITIONS
from utils.models import fit_zt_nbd, fit_gamma_gamma, get_churn_summary
from utils.outreach import (
    generate_coupon_code, build_email_link, build_whatsapp_link,
    generate_upgrade_message, generate_winback_message, generate_explorer_message
)
from utils import wizard
from utils.styles import COLORS, FONTS, apply_custom_css
from utils.pdf_report import create_bizpulse_report
import io

# Page config
st.set_page_config(
    page_title="BizPulse",
    page_icon="◉",
    layout="wide",
    initial_sidebar_state="collapsed"
)

# Apply global styles
apply_custom_css()

# =============================================================================
# SESSION STATE
# =============================================================================
def init_session_state():
    defaults = {
        "logged_in": False,
        "data_loaded": False,
        "business_name": None,
        "email": None,
        "raw_data": None,
        "customer_data": None,
        "current_view": "login",
        # Wizard State
        "wizard_step": 1,
        "wizard_source": "Generic CSV",
        "wizard_mappings": {},
        "wizard_rules": {},
        "wizard_summary": None,
        "uploaded_df": None, # Temp storage for wizard raw upload
        "global_start_date": None,
        "global_end_date": None,
    }
    for key, value in defaults.items():
        if key not in st.session_state:
            st.session_state[key] = value

init_session_state()


# =============================================================================
# HEADER & CONTROL PLANE
# =============================================================================
def render_header(pdf_bytes=None, business_name="BizPulse", start_date=None, end_date=None):
    """
    Renders the fixed 'Control Plane' header:
    1. Identity Bar (Deep Blue): Logo | Customer Name ..... Actions
    2. Context Bar (Light Grey): Global Date Range / filters
    """
    
    # Default dates if none provided
    if not start_date: start_date = "Jan 1, 2025"
    if not end_date: end_date = "Dec 31, 2025"
    
    st.markdown(f"""
    <style>
        /* 1. Global Layout Resets */
        header {{visibility: hidden;}} /* Hide Streamlit hamburger */
        .block-container {{
            padding-top: 9rem !important; /* Blue bar (6.5) + Context (approx) */
            padding-bottom: 5rem;
            max_width: 1200px;
        }}
        
        /* 2. Identity Bar (Top, Blue) */
        .identity-bar {{
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 6.5rem; /* REQUESTED: Double Width (tall) */
            background-color: {COLORS['header_bg']};
            z-index: 1000;
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 0 3rem; /* More padding x */
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
        }}
        
        .identity-left {{
            display: flex;
            align-items: center;
            gap: 2rem;
            color: white;
            font-family: 'Inter', sans-serif;
        }}
        
        .brand-logo {{
            font-weight: 800;
            font-size: 2rem; /* Larger Logo */
            letter-spacing: -0.02em;
        }}
        
        .customer-name {{
            font-weight: 400;
            font-size: 1.5rem; /* Larger Name */
            opacity: 0.9;
            border-left: 1px solid rgba(255,255,255,0.3);
            padding-left: 2rem;
        }}

        /* 3. Context Bar (Bottom, Grey) */
        .context-bar {{
            position: fixed;
            top: 6.5rem; /* Below Identity Bar */
            left: 0;
            width: 100%;
            height: 1.5rem; /* Minimal context strip */
            background-color: {COLORS['context_bg']};
            z-index: 999;
            border-bottom: 1px solid {COLORS['border']};
            display: flex;
            align-items: center;
            padding: 0 3rem;
            color: {COLORS['text_secondary']};
            font-size: 0.85rem;
            font-weight: 500;
        }}
        
        /* 4. Utility Classes */
        .metric-card {{
            background: white;
            border: 1px solid {COLORS['border']};
            border-radius: 8px;
            padding: 1.5rem;
            box-shadow: {COLORS.get('card_shadow', '0 1px 3px rgba(0,0,0,0.05)')};
            height: 100%;
        }}
        .metric-label {{
            font-size: 0.8rem;
            text-transform: uppercase;
            letter-spacing: 0.05em;
            color: {COLORS['text_muted']};
            margin-bottom: 0.5rem;
            font-weight: 600;
        }}
        .metric-value {{
            font-size: 2.2rem;
            font-weight: 700;
            color: {COLORS['text_primary']};
            letter-spacing: -0.03em;
            line-height: 1.1;
        }}
        
    </style>
    
    <!-- Identity Bar (HTML Part) -->
    <div class="identity-bar">
        <div class="identity-left">
            <div class="brand-logo">BizPulse</div>
            <div class="customer-name">{business_name}</div>
        </div>
        <!-- Right side (Actions) injected via Python below -->
    </div>
    """, unsafe_allow_html=True)

    # -------------------------------------------------------------------------
    # ACTION OVERLAYS (Buttons & Popover)
    # Using FIRST-OF-TYPE selectors since this is the first thing rendered.
    # -------------------------------------------------------------------------
    
    c_actions = st.container()
    with c_actions:
        # Define columns. Spacer | Export | Profile (Popover)
        col_spacer, col_pdf, col_profile = st.columns([7.5, 2, 0.5]) 
        
        with col_pdf:
            if pdf_bytes:
                st.download_button(
                    label="Export PDF Report",
                    data=pdf_bytes,
                    file_name=f"{business_name}_Report.pdf",
                    mime="application/pdf",
                    type="primary" # Will be overridden by CSS
                )
                
        with col_profile:
             # Use Popover for Profile Menu
             # Note: Popover button doesn't support key for styling usually, but we target by generic selector
             with st.popover("HP", use_container_width=False):
                 st.markdown(f"**{business_name}**")
                 st.caption("Settings")
                 st.button("Preferences", key="pref_btn", disabled=True)
                 st.button("Account", key="acct_btn", disabled=True)
                 st.divider()
                 if st.button("Logout", key="logout_btn", type="primary"):
                    st.session_state.logged_in = False
                    st.rerun()

    # CSS Injection for Header Actions
    # CRITICAL: Using :first-of-type because render_header is the very first thing.
    st.markdown(f"""
    <style>
    /* 1. EXPORT BUTTON (First Download Button) */
    div.stDownloadButton:first-of-type button {{
        position: fixed !important;
        top: 2.2rem !important; /* Vertically centered in 6.5rem header */
        right: 7rem !important;
        z-index: 1002 !important;
        height: 2.4rem !important;
        width: auto !important;
        max-width: 200px !important;
        min-width: 150px !important;
        background-color: {COLORS['brand_primary']} !important;
        color: white !important;
        border: 1px solid rgba(255,255,255,0.3) !important;
        box-shadow: 0 2px 4px rgba(0,0,0,0.1) !important;
        font-weight: 600 !important;
        border-radius: 6px !important;
        padding: 0 1rem !important;
        white-space: nowrap !important;
    }}
    div.stDownloadButton:first-of-type button:hover {{
        background-color: white !important;
        color: {COLORS['brand_primary']} !important;
    }}
    
    /* 2. PROFILE POPOVER BUTTON (First Popover) */
    /* Target the button that opens the popover. It is usually inside data-testid="stPopover" */
    div[data-testid="stPopover"]:first-of-type button {{
        position: fixed !important;
        top: 2.0rem !important;
        right: 2rem !important;
        z-index: 1002 !important;
        
        /* Circle Avatar Styling */
        width: 42px !important;
        height: 42px !important;
        border-radius: 50% !important; /* CIRCLE */
        padding: 0 !important;
        background-color: rgba(255,255,255,0.2) !important;
        color: white !important;
        border: 1px solid rgba(255,255,255,0.3) !important;
        font-weight: 600 !important;
        display: flex !important;
        align-items: center !important;
        justify-content: center !important;
    }}
    div[data-testid="stPopover"]:first-of-type button:hover {{
        background-color: white !important;
        color: {COLORS['brand_primary']} !important;
        border-color: white !important;
    }}
    
    /* 3. POPOVER CONTENT POSITIONING */
    /* Streamlit renders popovers in a layer/portal outside normal flow */
    /* We need to aggressively override the positioning */
    
    /* Target the layer container */
    [role="presentation"] {{
        left: auto !important;
        right: 0 !important;
    }}
    
    /* Target the popover content */
    [data-baseweb="popover"] {{
        left: auto !important;
        right: 1rem !important;
        top: 5rem !important;
        transform: none !important;
    }}
    
    /* Target popover body */
    [data-baseweb="popover"] > div {{
        left: auto !important;
        right: 0 !important;
    }}
    
    </style>
    """, unsafe_allow_html=True)



def calculate_health_score(customer_df, raw_df):
    """
    Returns a rich dictionary with score, trend, and component breakdown.
    Components:
    1. Retention (30pts): % active in last 60 days
    2. Loyalty (25pts): % Regular/Superuser
    3. Growth (25pts): New customer acquisition rate
    4. Value (20pts): Average Spend vs Target
    """
    components = {}
    
    # 1. Retention (30 pts)
    active_60 = len(customer_df[customer_df["days_since_visit"] <= 60])
    retention_rate = active_60 / len(customer_df) if len(customer_df) > 0 else 0
    retention_score = min(retention_rate * 100, 30)
    components["retention"] = {
        "score": retention_score, 
        "max": 30, 
        "label": "Retention",
        "value": f"{retention_rate:.0%}",
        "status": "Good" if retention_score > 20 else "Fair" if retention_score > 10 else "Poor"
    }

    # 2. Loyalty (25 pts)
    loyal = len(customer_df[customer_df["segment"].isin(["Regular", "Superuser"])])
    loyalty_rate = loyal / len(customer_df) if len(customer_df) > 0 else 0
    loyalty_score = min(loyalty_rate * 100 * 1.25, 25)
    components["loyalty"] = {
        "score": loyalty_score, 
        "max": 25, 
        "label": "Loyalty",
        "value": f"{loyalty_rate:.0%}",
        "status": "Good" if loyalty_score > 18 else "Fair" if loyalty_score > 10 else "Needs Work"
    }

    # 3. Growth (25 pts)
    if len(raw_df) > 0:
        recent_cutoff = raw_df["start"].max() - pd.Timedelta(days=90)
        first_visits = raw_df.groupby("client_name")["start"].min()
        new_customers = (first_visits >= recent_cutoff).sum()
        growth_rate = new_customers / len(customer_df) if len(customer_df) > 0 else 0
        growth_score = min(growth_rate * 100 * 2.5, 25)
        growth_text = f"+{new_customers} new"
    else:
        growth_score = 12.5
        growth_text = "N/A"
        
    components["growth"] = {
        "score": growth_score, 
        "max": 25, 
        "label": "Growth",
        "value": growth_text,
        "status": "Good" if growth_score > 15 else "Fair"
    }

    # 4. Value (20 pts)
    avg_value = customer_df["total_spend"].mean() if len(customer_df) > 0 else 0
    value_score = min((avg_value / 200) * 10, 20)
    components["value"] = {
        "score": value_score, 
        "max": 20, 
        "label": "Value",
        "value": f"${avg_value:.0f}",
        "status": "Good" if value_score > 12 else "Fair"
    }

    total_score = int(retention_score + loyalty_score + growth_score + value_score)
    
    # Determine Trend (Mock logic based on score for now, effectively)
    # Determine Trend (Mock logic based on score for now, effectively)
    if total_score >= 80:
        trend = "+5 vs last month"
        trend_color = COLORS["success"]
        status_label = "Excellent"
    elif total_score >= 70:
        trend = "+2 vs last month"
        trend_color = COLORS["success"]
        status_label = "Healthy"
    elif total_score >= 50:
        trend = "Stable"
        trend_color = COLORS["warning"]
        status_label = "Fair Health"
    else:
        trend = "-3 vs last month"
        trend_color = COLORS["danger"]
        status_label = "Needs Attention"
        
    return {
        "score": total_score,
        "status_label": status_label,
        "trend": trend,
        "trend": trend,
        "trend_color": trend_color,
        "components": components
    }

# get_health_trend is deprecated, logic moved inside calculate_health_score



def get_top_actions(customer_df, churn_results, segment_summary):
    actions = []

    # 1. Churn Recovery (High Priority)
    if churn_results["high_risk_count"] > 0:
        impact = churn_results["revenue_at_risk"] * 0.3
        actions.append({
            "type": "danger",
            "title": f"Recover {churn_results['high_risk_count']} At-Risk Customers",
            "impact_label": "Revenue Impact",
            "impact_value": f"${impact:,.0f}",
            "effort": "Medium",
            "time_est": "~30 min",
            "cta": "View Risk List"
        })

    # 2. Upgrades (Growth)
    casuals = customer_df[customer_df["segment"] == "Casual"]
    candidates = casuals[casuals["frequency"] >= 5]
    if len(candidates) > 0:
        impact = len(candidates) * 300 * 0.2
        actions.append({
            "type": "success",
            "title": f"Upgrade {len(candidates)} Casuals to Regulars",
            "impact_label": "Revenue Impact",
            "impact_value": f"+${impact:,.0f}",
            "effort": "Low",
            "time_est": "~10 min",
            "cta": "Send Upgrade Offer"
        })

    # 3. Retention (Overdue)
    dormant = customer_df[customer_df["days_since_visit"] > 45]
    if len(dormant) > 0:
        impact = dormant["total_spend"].sum() * 0.15
        actions.append({
            "type": "warning",
            "title": f"Prevent loss of {len(dormant)} Overdue Customers",
            "impact_label": "Revenue Impact",
            "impact_value": f"${impact:,.0f}",
            "effort": "Medium",
            "time_est": "~45 min",
            "cta": "Launch Win-Back"
        })

    # Fillers if fewer than 3
    while len(actions) < 3:
        actions.append({
            "type": "neutral",
            "title": "Expand your market reach",
            "impact_label": "Growth",
            "impact_value": "Variable",
            "effort": "High",
            "time_est": "~2 hrs",
            "cta": "Plan Marketing"
        })

    return actions[:3]


# =============================================================================
# LOGIN VIEW
# =============================================================================
def render_login():
    # Split screen layout using columns
    left_col, right_col = st.columns([58, 42], gap="small")

    with left_col:
        st.markdown(f"""
        <div style="height: 80vh; display: flex; flex-direction: column; justify-content: center; padding: 2rem 3rem;">
            <div class="wordmark">BizPulse</div>
            <h1 class="editorial-headline">Know your<br>business before<br>it surprises you.</h1>
            <p class="editorial-subhead">Turn customer data into clarity — in 60 seconds.</p>
        </div>
        """, unsafe_allow_html=True)

    with right_col:
        # Add vertical spacing to center the form
        st.markdown("<div style='height: 15vh;'></div>", unsafe_allow_html=True)

        st.markdown(f"""
        <div style="background: {COLORS["bg_white"]}; padding: 2.5rem;">
            <div class="form-panel">
                <div class="form-title" style="margin-bottom: 1.25rem;">Get your free Health Score</div>
        """, unsafe_allow_html=True)

        with st.form("login_form"):
            email = st.text_input("Email", placeholder="you@business.com")
            business_name = st.text_input("Business name", placeholder="Acme Coffee Shop")

            st.markdown("<div style='height: 0.5rem;'></div>", unsafe_allow_html=True)
            submitted = st.form_submit_button("Continue", use_container_width=True, type="primary")

            if submitted:
                if email and business_name:
                    st.session_state.email = email
                    st.session_state.business_name = business_name
                    st.session_state.logged_in = True
                    st.session_state.current_view = "upload"
                    st.rerun()
                else:
                    st.error("Please fill in both fields")

        st.markdown(f"""
                <div class="form-footer">Free forever for basic insights.</div>
            </div>
        </div>
        """, unsafe_allow_html=True)


# =============================================================================
# UPLOAD VIEW
# =============================================================================
def render_upload():
    # Progress Bar / Stepper
    steps = ["Upload", "Map Columns", "Validate", "Confirm"]
    current_step = st.session_state.wizard_step
    
    # Simple Stepper UI
    cols = st.columns(len(steps))
    for i, step in enumerate(steps):
        is_active = (i + 1) == current_step
        is_done = (i + 1) < current_step
        color = COLORS["green"] if (is_active or is_done) else COLORS["border"]
        weight = "600" if is_active else "400"
        
        cols[i].markdown(f"""
        <div style="border-top: 4px solid {color}; padding-top: 0.5rem; text-align: center;">
            <span style="font-family: {FONTS['body']}; font-weight: {weight}; color: {COLORS['text_primary']}; font-size: 0.85rem;">
                Step {i+1}<br>{step}
            </span>
        </div>
        """, unsafe_allow_html=True)
            
    st.markdown("<div style='height: 2rem;'></div>", unsafe_allow_html=True)

    # =========================================================================
    # STEP 1: UPLOAD & SOURCE
    # =========================================================================
    if current_step == 1:
        c1, c2 = st.columns([1, 1], gap="large")
        
        with c1:
            st.markdown(f"""
            <h2 style="font-family:{FONTS['display']}; margin-bottom:1rem;">Upload your data</h2>
            <p style="color:{COLORS['text_muted']};">Drag and drop your transaction export. We'll guide you through the rest.</p>
            """, unsafe_allow_html=True)
            
            uploaded_file = st.file_uploader("Upload CSV", type="csv", label_visibility="collapsed")
            
            if uploaded_file:
                # Load first time
                if st.session_state.uploaded_df is None:
                    try:
                        df = pd.read_csv(uploaded_file)
                        st.session_state.uploaded_df = df
                        # Auto-detect source
                        detected = wizard.detect_source(df)
                        st.session_state.wizard_source = detected
                    except Exception as e:
                        st.error(f"Error reading CSV: {e}")

        with c2:
            st.markdown(f"<h3>Where is this file from?</h3>", unsafe_allow_html=True)
            
            sources = ["Square", "Toast", "Shopify", "Appointments (Generic)", "Generic CSV"]
            
            # If we have a detected source, highlight it
            current_src = st.session_state.wizard_source
            
            selected_src = st.radio("Select Source", sources, index=sources.index(current_src) if current_src in sources else 4)
            st.session_state.wizard_source = selected_src
            
            if st.session_state.uploaded_df is not None:
                st.info(f"Detected: {len(st.session_state.uploaded_df)} rows. Source: {current_src}")
                
                if st.button("Next: Map Columns →", type="primary"):
                    st.session_state.wizard_step = 2
                    st.rerun()

    # =========================================================================
    # STEP 2: MAPPING
    # =========================================================================
    elif current_step == 2:
        df = st.session_state.uploaded_df
        st.markdown(f"<h3>Map your columns</h3>", unsafe_allow_html=True)
        
        c1, c2 = st.columns([2, 1], gap="large")
        
        # Pre-calculate suggestions if not already done
        if not st.session_state.wizard_mappings:
            suggestions = wizard.get_column_suggestions(df, st.session_state.wizard_source)
            # Flatten to just col names for the default dict
            defaults = {k: v['col'] for k, v in suggestions.items() if v['col']}
            st.session_state.wizard_mappings = defaults

        with c1:
            st.dataframe(df.head(10), use_container_width=True)
            
        with c2:
            with st.form("mapping_form"):
                st.markdown("**Required Fields**")
                
                cols = list(df.columns)
                mappings = {}
                
                # Helper to get index safely
                def get_idx(val):
                    return cols.index(val) if val in cols else 0

                # Date
                cur_date = st.session_state.wizard_mappings.get('date')
                mappings['date'] = st.selectbox("Transaction Date", cols, index=get_idx(cur_date), 
                                                help="The primary timestamp of the transaction")
                
                # Amount
                cur_amt = st.session_state.wizard_mappings.get('amount')
                mappings['amount'] = st.selectbox("Total Amount", cols, index=get_idx(cur_amt),
                                                  help="The total value of the transaction (revenue)")
                
                # Customer
                cur_cust = st.session_state.wizard_mappings.get('customer_id')
                mappings['customer_id'] = st.selectbox("Customer Identifier", cols, index=get_idx(cur_cust),
                                                       help="Email, Name, or ID to group by")
                
                # Status
                cur_stat = st.session_state.wizard_mappings.get('status')
                mappings['status'] = st.selectbox("Status Column", [None] + cols, index=get_idx(cur_stat) + 1 if cur_stat else 0,
                                                  help="Optional: Used to filter out cancelled/refunded")
                
                submitted = st.form_submit_button("Next: Validate →")
                if submitted:
                    st.session_state.wizard_mappings = mappings
                    st.session_state.wizard_step = 3
                    st.rerun()
                    
            if st.button("← Back"):
                st.session_state.wizard_step = 1
                st.rerun()

    # =========================================================================
    # STEP 3: VALIDATION
    # =========================================================================
    elif current_step == 3:
        st.markdown(f"<h3>Validation & Rules</h3>", unsafe_allow_html=True)
        
        df = st.session_state.uploaded_df
        mappings = st.session_state.wizard_mappings
        
        c1, c2 = st.columns([1, 1], gap="large")
        
        with c1:
            st.markdown("#### Configuration")
            
            # Status Rules
            included_statuses = []
            if mappings.get('status'):
                unique_statuses = df[mappings['status']].astype(str).unique()
                st.write("Which statuses should we include?")
                # Default logic: exclude 'refunded', 'void', 'cancelled'
                defaults = [s for s in unique_statuses if not any(x in s.lower() for x in ['cancel', 'void', 'refund', 'fail'])]
                included_statuses = st.multiselect("Select valid statuses", unique_statuses, default=defaults)
            else:
                st.info("No status column mapped. All rows will be imported.")
            
            rules = {"included_statuses": included_statuses}
            
            # Live Validation
            summary = wizard.generate_validation_summary(df, mappings, rules)
            st.session_state.wizard_summary = summary
            st.session_state.wizard_rules = rules
            
            if st.button("Next: Confirm →", type="primary"):
                st.session_state.wizard_step = 4
                st.rerun()
            
            if st.button("← Back"):
                st.session_state.wizard_step = 2
                st.rerun()

        with c2:
            st.markdown("#### Validation Summary")
            
            summ = st.session_state.wizard_summary
            if summ:
                st.markdown(f"""
                <div style="background: white; padding: 1.5rem; border-radius: 8px; border: 1px solid {COLORS['border']};">
                    <div style="display:flex; justify-content:space-between; margin-bottom:0.5rem;">
                        <span>Total Rows Found</span>
                        <strong>{summ['total_rows']:,}</strong>
                    </div>
                    <div style="display:flex; justify-content:space-between; margin-bottom:0.5rem; color:{COLORS['success']};">
                        <span>Rows to Import</span>
                        <strong>{summ['clean_rows']:,}</strong>
                    </div>
                    <div style="display:flex; justify-content:space-between; margin-bottom:0.5rem; color:{COLORS['text_muted']};">
                        <span>Rows Excluded</span>
                        <span>{summ['excluded_rows']:,}</span>
                    </div>
                    <hr style="margin:1rem 0; border:0; border-top:1px solid #eee;">
                    <div style="display:flex; justify-content:space-between;">
                        <span>Unique Customers</span>
                        <strong>{summ['unique_customers']:,}</strong>
                    </div>
                    <div style="display:flex; justify-content:space-between;">
                        <span>Date Range</span>
                        <span>{summ['date_range']}</span>
                    </div>
                </div>
                """, unsafe_allow_html=True)
                
                if summ['warnings']:
                    st.warning("Warnings:\n" + "\n".join([f"- {w}" for w in summ['warnings']]))
                else:
                    st.success("Data looks clean!")

    # =========================================================================
    # STEP 4: CONFIRMATION
    # =========================================================================
    elif current_step == 4:
        st.markdown(f"""
        <div style="text-align: center; padding: 3rem;">
            <div style="font-size: 4rem; margin-bottom: 1rem;">✅</div>
            <h2 style="font-family:{FONTS['display']};">Import Complete</h2>
            <p>Your data is ready for analysis.</p>
        </div>
        """, unsafe_allow_html=True)
        
        c1, c2, c3 = st.columns([1, 2, 1])
        with c2:
            summ = st.session_state.wizard_summary
            st.markdown(f"""
            <div class="stat-card">
                <div style="display:grid; grid-template-columns: 1fr 1fr; gap:1rem; text-align:center;">
                    <div>
                        <div class="stat-value">{summ['clean_rows']:,}</div>
                        <div class="stat-label">Transactions</div>
                    </div>
                    <div>
                        <div class="stat-value">{summ['unique_customers']:,}</div>
                        <div class="stat-label">Customers</div>
                    </div>
                </div>
            </div>
            """, unsafe_allow_html=True)
            
            if st.button("Continue to Insights →", type="primary", use_container_width=True):
                 # FINALIZE processing
                with st.spinner("Finalizing..."):
                    clean_df = wizard.process_and_finalize(
                        st.session_state.uploaded_df,
                        st.session_state.wizard_mappings,
                        st.session_state.wizard_rules
                    )
                    st.session_state.raw_data = clean_df
                    st.session_state.uploaded_df = None # Clear temp
                    
                    # Generate derived data
                    customer_df = aggregate_to_customers(clean_df)
                    customer_df = assign_segments(customer_df)
                    st.session_state.customer_data = customer_df
                    
                    st.session_state.data_loaded = True
                    st.session_state.current_view = "dashboard"
                    st.rerun()

        st.markdown(f"""
            </div>
        </div>
        """, unsafe_allow_html=True)


# =============================================================================
# DASHBOARD VIEW
# =============================================================================
def render_dashboard():
    raw_df = st.session_state.raw_data
    customer_df = st.session_state.customer_data
    business_name = st.session_state.business_name

    # Dashboard container
    st.markdown("""<div class="dashboard-container">""", unsafe_allow_html=True)

    # =========================================================================
    # HEADER
    # =========================================================================
    
    # =========================================================================
    # LOGIC: DATE & DATA
    # =========================================================================
    raw_df = st.session_state.raw_data
    min_date = raw_df["start"].min().date()
    max_date = raw_df["start"].max().date()
    
    if not st.session_state.global_start_date:
        default_start = max(min_date, (pd.Timestamp.now() - pd.Timedelta(days=365)).date())
        st.session_state.global_start_date = default_start
        st.session_state.global_end_date = max_date

    # =========================================================================
    # RENDER: HEADER (Fixed)
    # =========================================================================
    # Pre-calc metrics for report so we can pass the buffer
    global_customer_df = aggregate_to_customers(
        raw_df, 
        start_date=st.session_state.global_start_date, 
        end_date=st.session_state.global_end_date
    )
    # Assign Segments (Required for Health Score)
    global_customer_df = assign_segments(global_customer_df)
    
    # Recalculate health for report
    health_data = calculate_health_score(global_customer_df, raw_df) 
    
    # Calculate deps for Actions
    churn_results = get_churn_summary(global_customer_df)
    segment_summary = get_segment_summary(global_customer_df)
    
    top_actions = get_top_actions(global_customer_df, churn_results, segment_summary)
    
    report_buffer = io.BytesIO()
    create_bizpulse_report(report_buffer, business_name, health_data, top_actions, global_customer_df)
    report_buffer.seek(0)
    
    render_header(report_buffer, business_name)

    # =========================================================================
    # RENDER: ANALYSIS PERIOD (Date Picker Row)
    # =========================================================================
    
    # Date Picker Row: Label | From | To | Analyze Button
    col_label, col_from, col_to, col_btn, col_spacer = st.columns([1.5, 1.5, 1.5, 1, 4.5])
    
    with col_label:
        st.markdown(f"""
        <div style="padding-top: 0.5rem; font-weight: 600; color: {COLORS['text_primary']}; font-size: 0.95rem;">
            Analysis Period
        </div>
        """, unsafe_allow_html=True)
    
    with col_from:
        from_date = st.date_input(
            "From",
            value=st.session_state.global_start_date,
            min_value=min_date,
            max_value=max_date,
            key="date_from"
        )
        if from_date:
            st.session_state.global_start_date = from_date
    
    with col_to:
        to_date = st.date_input(
            "To",
            value=st.session_state.global_end_date,
            min_value=min_date,
            max_value=max_date,
            key="date_to"
        )
        if to_date:
            st.session_state.global_end_date = to_date
    
    with col_btn:
        st.markdown("<div style='padding-top: 1.5rem;'></div>", unsafe_allow_html=True)
        if st.button("Analyze", key="analyze_btn", type="primary"):
            st.rerun()
    
    # CSS to constrain date input width and position calendar popups
    st.markdown(f"""
    <style>
    /* Constrain date input field width */
    div[data-testid="stDateInput"] input {{
        max-width: 140px !important;
    }}
    
    /* Position calendar popups - Streamlit renders these in a layer/portal */
    /* Target the calendar container */
    [data-baseweb="calendar"] {{
        position: fixed !important;
        top: 12rem !important;
        left: auto !important;
        right: auto !important;
        transform: none !important;
    }}
    
    /* Target the layer/popover that contains the calendar */
    [data-baseweb="popover"][role="dialog"] {{
        position: fixed !important;
        top: 12rem !important;
        left: 15% !important;
        transform: none !important;
    }}
    
    /* Alternative: target by layer manager */
    [data-baseweb="layer"] {{
        position: fixed !important;
        top: 12rem !important;
        left: 15% !important;
    }}
    </style>
    """, unsafe_allow_html=True)
    
    st.markdown("<div style='margin-bottom: 0.5rem;'></div>", unsafe_allow_html=True) 
    # Logic verified above
    global_customer_df = assign_segments(global_customer_df)
    
    health_data = calculate_health_score(global_customer_df, raw_df)
    score = health_data["score"]
    status_label = health_data.get("status_label", "Health")
    trend_text = health_data["trend"]
    trend_color = health_data["trend_color"]
    components = health_data["components"]
    
    churn_results = get_churn_summary(global_customer_df)
    segment_summary = get_segment_summary(global_customer_df)
    top_actions = get_top_actions(global_customer_df, churn_results, segment_summary)

    # Header already rendered efficiently above
    
    st.markdown(f"""<div style="margin-bottom: 2rem;"></div>""", unsafe_allow_html=True)

    # SVG Circle Meter
    radius = 80
    stroke_width = 10
    circumference = 2 * 3.14159 * radius
    progress = score / 100
    stroke_dashoffset = circumference * (1 - progress)
    
    if score >= 70:
        meter_color = COLORS["success"]
    elif score >= 50:
        meter_color = COLORS["warning"]
    else:
        meter_color = COLORS["danger"]

    # Construct HTML for Score Card (Left)
    breakdown_html = ""
    for key, data in components.items():
        status_color = COLORS["success"] if "Good" in data["status"] else (COLORS["warning"] if "Fair" in data["status"] else COLORS["danger"])
        # Tightened spacing
        breakdown_html += f"""
<div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:0.4rem; font-size:0.85rem;">
    <div style="color:{COLORS['text_secondary']};">{data['label']}</div>
    <div style="text-align:right;">
        <div style="font-weight:600; color:{COLORS['text_primary']};">{data['value']}</div>
        <div style="font-size:0.7rem; color:{status_color};">{data['status']}</div>
    </div>
</div>
""".replace('\n', ' ')

    score_card_html = f"""
<div class="card" style="height: 100%;">
    <div style="margin-bottom:1.5rem;">
        <div class="metric-label" style="text-transform:uppercase; letter-spacing:0.05em; font-size:0.75rem;">Health Score</div>
        <div style="display:flex; align-items:baseline; gap:0.5rem;">
             <div style="font-size:1.1rem; font-weight:600; color:{COLORS['text_primary']};">{score} <span style="font-weight:400; color:{COLORS['text_secondary']}">/ 100</span></div>
             <div style="font-size:0.9rem; font-weight:500; color:{COLORS['text_primary']};">— {status_label}</div>
        </div>
        <div style="color:{trend_color}; font-size:0.8rem; margin-top:0.1rem;">{trend_text}</div>
    </div>
    
    <div style="display:flex; gap:1.5rem; align-items:center;">
        <div style="position:relative; width:120px; height:120px; flex-shrink:0;">
            <svg width="120" height="120" viewBox="0 0 140 140" style="transform: rotate(-90deg);">
                <circle cx="70" cy="70" r="{radius}" fill="none" stroke="{COLORS['bg_subtle']}" stroke-width="{stroke_width}"/>
                <circle cx="70" cy="70" r="{radius}" fill="none" stroke="{meter_color}" stroke-width="{stroke_width}" stroke-linecap="round" stroke-dasharray="{circumference}" stroke-dashoffset="{stroke_dashoffset}" style="transition: stroke-dashoffset 0.8s ease;"/>
            </svg>
            <div style="position:absolute; top:50%; left:50%; transform:translate(-50%, -50%); font-size:2rem; font-weight:700; color:{COLORS['text_primary']};">
                {score}
            </div>
        </div>
        <div style="flex:1; border-left:1px solid {COLORS['border']}; padding-left:1.5rem;">
            {breakdown_html}
        </div>
    </div>
</div>
""".replace('\n', ' ')

    # =========================================================================
    # COMBINED PANEL: Health Score + Top Priorities
    # =========================================================================
    
    # Use a container and style it as a card via CSS
    with st.container():
        # Add CSS to style this specific container as a card
        st.markdown("""
        <style>
        /* Style the combined panel container */
        div[data-testid="stVerticalBlock"] > div:has(> div[data-testid="stHorizontalBlock"]) {
            background: white;
            border: 1px solid #E5E7EB;
            border-radius: 8px;
            padding: 2rem;
            box-shadow: 0 1px 3px rgba(0,0,0,0.05);
        }
        </style>
        """, unsafe_allow_html=True)
        
        # Two columns inside the card
        col_health, col_divider, col_actions = st.columns([1, 0.05, 2])
        
        with col_health:
            st.markdown(f"""
            <div style="margin-bottom: 1.5rem;">
                <div style="text-transform: uppercase; letter-spacing: 0.05em; font-size: 0.75rem; color: {COLORS['text_muted']}; font-weight: 600; margin-bottom: 0.5rem;">Business Health Score</div>
                <div style="display: flex; align-items: baseline; gap: 0.5rem;">
                    <div style="font-size: 1.1rem; font-weight: 600; color: {COLORS['text_primary']};">{score} <span style="font-weight: 400; color: {COLORS['text_secondary']}">/100</span></div>
                    <div style="font-size: 0.9rem; font-weight: 500; color: {COLORS['text_primary']};">— {status_label}</div>
                </div>
                <div style="color: {trend_color}; font-size: 0.8rem; margin-top: 0.1rem;">{trend_text}</div>
            </div>
            
            <div style="display: flex; gap: 2rem; align-items: center;">
                <div style="position: relative; width: 180px; height: 180px; flex-shrink: 0;">
                    <svg width="180" height="180" viewBox="0 0 200 200" style="transform: rotate(-90deg);">
                        <circle cx="100" cy="100" r="{radius}" fill="none" stroke="{COLORS['bg_subtle']}" stroke-width="{stroke_width}"/>
                        <circle cx="100" cy="100" r="{radius}" fill="none" stroke="{meter_color}" stroke-width="{stroke_width}" stroke-linecap="round" stroke-dasharray="{circumference}" stroke-dashoffset="{stroke_dashoffset}" style="transition: stroke-dashoffset 0.8s ease;"/>
                    </svg>
                    <div style="position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); font-size: 3rem; font-weight: 700; color: {COLORS['text_primary']};">
                        {score}
                    </div>
                </div>
                <div style="flex: 1; border-left: 1px solid {COLORS['border']}; padding-left: 2rem;">
                    {breakdown_html}
                </div>
            </div>
            """, unsafe_allow_html=True)
        
        with col_divider:
            st.markdown(f"""
            <div style="height: 100%; width: 2px; background-color: {COLORS['border']}; margin: 0 auto;"></div>
            """, unsafe_allow_html=True)
        
        with col_actions:
            st.markdown(f"""
            <div style="margin-bottom: 1rem;">
                <div style="font-weight: 600; color: {COLORS['text_primary']}; font-size: 1.1rem;">Your Top 3 Actions</div>
                <div style="font-size: 0.85rem; color: {COLORS['text_secondary']}; margin-top: 0.2rem;">Based on your last 12 months of customer behavior</div>
            </div>
            """, unsafe_allow_html=True)
            
            for i, action in enumerate(top_actions):
                # Determine Colors
                if action['type'] == 'danger':
                    border_color = COLORS['danger']
                elif action['type'] == 'success':
                    border_color = COLORS['success']
                elif action['type'] == 'warning':
                    border_color = COLORS['warning']
                else:
                    border_color = COLORS['text_secondary']
                    
                time_est = action.get("time_est", "~15 min")

                # Card Container using Columns: Number | Content | Button
                c_num, c_content, c_btn = st.columns([0.08, 0.67, 0.25])
                
                with c_num:
                    st.markdown(f"""
                    <div style="display: flex; align-items: center; justify-content: center; width: 28px; height: 28px; background-color: {border_color}; color: white; border-radius: 50%; font-weight: 700; font-size: 0.9rem;">
                        {i+1}
                    </div>
                    """, unsafe_allow_html=True)
                
                with c_content:
                    st.markdown(f"""
                    <div style="display: flex; flex-direction: column; justify-content: center; height: 100%; padding-top: 0.1rem;">
                        <div style="font-weight: 600; font-size: 0.95rem; color: {COLORS['text_primary']}; margin-bottom: 0.2rem;">{action['title']}</div>
                        <div style="font-size: 0.8rem; color: {COLORS['text_secondary']}; display: flex; align-items: center; gap: 0.5rem;">
                            <span>{action['impact_label']}: <strong style="color: {COLORS['text_primary']};">{action['impact_value']}</strong></span>
                            <span style="color: {COLORS['border']}">|</span>
                            <span>{time_est}</span>
                        </div>
                    </div>
                    """, unsafe_allow_html=True)
                
                with c_btn:
                    st.markdown("<div style='height: 0.3rem'></div>", unsafe_allow_html=True) 
                    if st.button(action['cta'], key=f"action_btn_{i}", use_container_width=True):
                        # Action Logic
                        if action['type'] == 'danger':
                            st.session_state['triggered_action'] = 'retention'
                        elif action['type'] == 'success':
                            st.session_state['triggered_action'] = 'upgrades'
                        elif action['type'] == 'warning':
                            st.session_state['triggered_action'] = 'churn'
                        st.rerun()

                # Spacer
                st.markdown("<div style='height: 0.35rem'></div>", unsafe_allow_html=True)

    st.markdown("<div style='height: 1rem;'></div>", unsafe_allow_html=True)

    # Action Drill Down Logic
    active_trigger = st.session_state.get('triggered_action')
    
    if active_trigger:
        # Show Back Button and Specific View
        col_back, col_title = st.columns([0.15, 0.85])
        with col_back:
            if st.button("← Back", key="back_to_dash"):
                st.session_state['triggered_action'] = None
                st.rerun()
        
        st.markdown("<hr style='margin-top: 0; margin-bottom: 2rem;'>", unsafe_allow_html=True)
                
        if active_trigger == 'retention':
            render_retention_tab(global_customer_df)
        elif active_trigger == 'upgrades':
            render_upgrades_tab(global_customer_df, business_name)
        elif active_trigger == 'churn':
            render_churn_tab(global_customer_df, business_name)
            
    else:
        # Standard Tabs
        tabs = st.tabs(["Overview", "Segments", "Retention", "Upgrades", "CLV", "Churn"])
    # Removed footer text as requested
    
        with tabs[0]:
            render_overview_tab(global_customer_df, raw_df, segment_summary)
        with tabs[1]:
            render_segments_tab(global_customer_df)
        with tabs[2]:
            render_retention_tab(global_customer_df)
        with tabs[3]:
            render_upgrades_tab(global_customer_df, business_name)
        with tabs[4]:
            render_clv_tab(global_customer_df)
        with tabs[5]:
            render_churn_tab(global_customer_df, business_name)


# =============================================================================
# TAB: OVERVIEW
# =============================================================================
def render_overview_tab(customer_df, raw_df, segment_summary):
    total_customers = len(customer_df)
    total_revenue = customer_df["total_spend"].sum()
    avg_visits = customer_df["frequency"].mean()
    active_rate = len(customer_df[customer_df["days_since_visit"] <= 60]) / total_customers if total_customers > 0 else 0

    # New Hierarchical Metrics Grid
    mc1, mc2, mc3, mc4 = st.columns(4)
    
    with mc1:
        st.markdown(f"""
        <div class="metric-card">
            <div class="metric-label">Total Customers</div>
            <div class="metric-value">{total_customers:,}</div>
            <div class="metric-trend trend-up">↑ 12% vs last year</div>
        </div>
        """, unsafe_allow_html=True)
        
    with mc2:
         st.markdown(f"""
        <div class="metric-card">
            <div class="metric-label">Total Revenue</div>
            <div class="metric-value">${total_revenue:,.0f}</div>
            <div class="metric-trend trend-up">↑ 8% vs last year</div>
        </div>
        """, unsafe_allow_html=True)
        
    with mc3:
         st.markdown(f"""
        <div class="metric-card">
            <div class="metric-label">Avg Visits</div>
            <div class="metric-value">{avg_visits:.1f}</div>
            <div class="metric-trend trend-down">↓ 2% vs last year</div>
        </div>
        """, unsafe_allow_html=True)
         
    with mc4:
         st.markdown(f"""
        <div class="metric-card">
            <div class="metric-label">Active Rate</div>
            <div class="metric-value">{active_rate:.0%}</div>
            <div class="metric-trend trend-neutral">Stable</div>
        </div>
        """, unsafe_allow_html=True)
        
    st.markdown("<div style='margin-bottom: 3rem;'></div>", unsafe_allow_html=True)

    st.markdown('<div class="section-header">Customer Segments</div>', unsafe_allow_html=True)

    c1, c2 = st.columns(2)

    with c1:
        st.markdown(f"<div style='margin-bottom:1rem; font-weight:600; color:{COLORS['text_secondary']}'>Distribution</div>", unsafe_allow_html=True)
        fig = go.Figure()
        # Use simple Green for consistency
        colors = [COLORS["brand_primary"]] * 4 
        
        # Sort by count for better visual
        seg_sorted = segment_summary.sort_values("customer_count", ascending=True)

        fig.add_trace(go.Bar(
            y=seg_sorted["segment"],
            x=seg_sorted["customer_count"],
            orientation='h',
            marker_color=COLORS["brand_primary"], # Green Consistency
            text=seg_sorted["customer_count"].apply(lambda x: f"{x:,}"),
            textposition='auto',
            textfont=dict(color="white", size=12, family="Inter"),
            hoverinfo="y+x"
        ))

        fig.update_layout(
            height=280,
            margin=dict(t=0, b=20, l=0, r=0),
            paper_bgcolor="rgba(0,0,0,0)",
            plot_bgcolor="rgba(0,0,0,0)",
            xaxis=dict(showgrid=True, gridcolor=COLORS["border"], showline=False, tickfont=dict(color=COLORS["text_muted"], family="Inter")),
            yaxis=dict(showgrid=False, showline=False, tickfont=dict(color=COLORS["text_primary"], family="Inter", size=13)),
            font=dict(family="Inter, sans-serif")
        )
        st.plotly_chart(fig, use_container_width=True)

    with c2:
        st.markdown(f"<div style='margin-bottom:1rem; font-weight:600; color:{COLORS['text_secondary']}'>Revenue Contribution</div>", unsafe_allow_html=True)
        fig = go.Figure()
        
        # Sort by revenue
        rev_sorted = segment_summary.sort_values("total_revenue", ascending=False)
        
        # Logic: If revenue is basically 0, we still show the chart but maybe with a watermark?
        # User requested: "right plot should be revenue... instead of avg visits"
        
        fig.add_trace(go.Bar(
            x=rev_sorted["segment"],
            y=rev_sorted["total_revenue"],
            marker_color=COLORS["brand_primary"], # Green
            text=rev_sorted["total_revenue"].apply(lambda x: f"${x/1000:.1f}k" if x >= 1000 else (f"${x:.0f}" if x > 0 else "")),
            textposition='auto',
            textfont=dict(color="white", size=12, family="Inter"),
            hoverinfo="x+y"
        ))

        # Add annotation if no revenue
        if total_revenue < 100:
            fig.add_annotation(
                text="No Revenue Data Available",
                xref="paper", yref="paper",
                x=0.5, y=0.5, showarrow=False,
                font=dict(size=14, color=COLORS['text_muted'])
            )

        fig.update_layout(
            height=280,
            margin=dict(t=0, b=20, l=0, r=0),
            paper_bgcolor="rgba(0,0,0,0)",
            plot_bgcolor="rgba(0,0,0,0)",
            xaxis=dict(showgrid=False, showline=True, linecolor=COLORS["border"], tickfont=dict(color=COLORS["text_primary"], family="Inter")),
            yaxis=dict(showgrid=True, gridcolor=COLORS["border"], showline=False, tickfont=dict(color=COLORS["text_muted"], family="Inter"), title=""),
            font=dict(family="Inter, sans-serif")
        )
        st.plotly_chart(fig, use_container_width=True)

    superusers = segment_summary[segment_summary["segment"] == "Superuser"]
    
    # Smart Insight Logic
    insight_text = ""
    # 1. Identify Most Valuable Segment
    top_seg = segment_summary.sort_values("total_revenue", ascending=False).iloc[0]
    top_seg_name = top_seg['segment']
    top_seg_rev = top_seg['total_revenue']
    top_seg_pct = top_seg_rev / total_revenue if total_revenue > 0 else 0
    
    if total_revenue > 100:
        if top_seg_pct > 0.5:
            insight_text = f"Your <strong>{top_seg_name}s</strong> drive the business, generating <strong>{top_seg_pct:.0%}</strong> of total revenue."
        else:
             insight_text = f"Revenue is balanced, led by <strong>{top_seg_name}s</strong> ({top_seg_pct:.0%} contribution)."
    else:
        # Fallback based on Frequency
        top_freq_seg = customer_df.groupby('segment')['frequency'].mean().sort_values(ascending=False).index[0]
        # Calculate X times
        top_freq_val = customer_df[customer_df['segment']==top_freq_seg]['frequency'].mean()
        avg_freq = customer_df['frequency'].mean()
        mult = top_freq_val / avg_freq if avg_freq > 0 else 1.0
        insight_text = f"Your <strong>{top_freq_seg}s</strong> are your most engaged group, visiting <strong>{mult:.1f}x</strong> more often than average."

    if insight_text:
        st.markdown(f"""
        <div style="background-color: {COLORS['success_bg']}; border-left: 5px solid {COLORS['success']}; padding: 1.25rem; border-radius: 8px; margin-top: 1rem;">
            <p style="margin: 0; color: {COLORS['brand_primary']}; font-size: 1rem;">
                💡 <strong>Key Insight:</strong> {insight_text}
            </p>
        </div>
        """, unsafe_allow_html=True)


# =============================================================================
# TAB: SEGMENTS
# =============================================================================
def render_segments_tab(customer_df):
    segment_summary = get_segment_summary(customer_df)
    
    # --- 1. Charts Section (Matching PDF Logic) ---
    total_rev = customer_df['total_spend'].sum() if 'total_spend' in customer_df.columns else 0
    show_revenue = total_rev > 100

    c1, c2 = st.columns(2)
    
    with c1:
        st.markdown(f"<div style='margin-bottom:1rem; font-weight:600; color:{COLORS['text_secondary']}'>Customer Distribution</div>", unsafe_allow_html=True)
        fig = go.Figure()
        # Sort by count
        seg_sorted = segment_summary.sort_values("customer_count", ascending=True)
        
        fig.add_trace(go.Bar(
            y=seg_sorted["segment"],
            x=seg_sorted["customer_count"],
            orientation='h',
            marker_color=COLORS["brand_primary"], # Green Consistency
            text=seg_sorted["customer_count"].apply(lambda x: f"{x:,}"),
            textposition='auto',
            textfont=dict(color="white", size=12, family="Inter"),
            hoverinfo="y+x"
        ))
        
        fig.update_layout(
            height=250,
            margin=dict(t=0, b=0, l=0, r=0),
            paper_bgcolor="rgba(0,0,0,0)",
            plot_bgcolor="rgba(0,0,0,0)",
            xaxis=dict(showgrid=True, gridcolor=COLORS["border"], showline=False, tickfont=dict(color=COLORS["text_muted"], family="Inter")),
            yaxis=dict(showgrid=False, showline=False, tickfont=dict(color=COLORS["text_primary"], family="Inter", size=13)),
            font=dict(family="Inter, sans-serif")
        )
        st.plotly_chart(fig, use_container_width=True)

    with c2:
        st.markdown(f"<div style='margin-bottom:1rem; font-weight:600; color:{COLORS['text_secondary']}'>Revenue Contribution</div>", unsafe_allow_html=True)
        fig = go.Figure()
        # Sort by revenue
        rev_sorted = segment_summary.sort_values("total_revenue", ascending=True) # Ascending for Horizontal
        
        fig.add_trace(go.Bar(
            y=rev_sorted["segment"],
            x=rev_sorted["total_revenue"],
            orientation='h', # match orientation
            marker_color=COLORS["brand_primary"], # Green
            text=rev_sorted["total_revenue"].apply(lambda x: f"${x/1000:.1f}k" if x >= 1000 else (f"${x:.0f}" if x > 0 else "")),
            textposition='auto',
            textfont=dict(color="white", size=12, family="Inter"),
            hoverinfo="x+y"
        ))

        # Add annotation if no revenue
        if total_rev < 100:
            fig.add_annotation(
                text="No Revenue Data Available",
                xref="paper", yref="paper",
                x=0.5, y=0.5, showarrow=False,
                font=dict(size=14, color=COLORS['text_muted'])
            )

        fig.update_layout(
            height=250,
            margin=dict(t=0, b=0, l=0, r=0),
            paper_bgcolor="rgba(0,0,0,0)",
            plot_bgcolor="rgba(0,0,0,0)",
            xaxis=dict(showgrid=True, gridcolor=COLORS["border"], showline=False, tickfont=dict(color=COLORS["text_muted"], family="Inter")),
            yaxis=dict(showgrid=False, showline=False, tickfont=dict(color=COLORS["text_primary"], family="Inter", size=13)),
            font=dict(family="Inter, sans-serif")
        )
        st.plotly_chart(fig, use_container_width=True)
    # Removed alternate view logic for consistency

    st.markdown("---")

    # Definitions & Strategies
    seg_meta = {
        "Explorer": {
            "def": "1-2 visits", 
            "strategy": "Goal: Build a habit. These customers are trying you out.",
            "color": "#00A376"
        },
        "Casual": {
            "def": "3-8 visits", 
            "strategy": "Goal: Increase frequency. Move them to Regular status.",
            "color": "#007A5E"
        },
        "Regular": {
            "def": "9-12 visits", 
            "strategy": "Goal: Maintain consistency. Don't let them churn.",
            "color": "#00574B"
        },
        "Superuser": {
            "def": "13+ visits", 
            "strategy": "Goal: Retention & Advocacy. Treat them like VIPs.",
            "color": COLORS["green"]
        }
    }

    st.markdown(f"<div style='display: grid; grid-template-columns: repeat(2, 1fr); gap: 1.5rem; margin-top: 1rem;'>", unsafe_allow_html=True)
    
    # Sort order: Explorer -> Superuser (or reverse?) let's do Explorer -> Superuser
    order = ["Explorer", "Casual", "Regular", "Superuser"]
    
    for seg_name in order:
        # Find row
        row = segment_summary[segment_summary["segment"] == seg_name]
        if len(row) == 0:
            count = 0
            rev = 0
        else:
            count = row.iloc[0]["customer_count"]
            rev = row.iloc[0]["total_revenue"]
            
        meta = seg_meta.get(seg_name)
        pct = count / len(customer_df) * 100 if len(customer_df) > 0 else 0
        
        st.markdown(f"""
<div class="card" style="border-left: 4px solid {meta['color']}; padding: 1.5rem;">
    <div style="display:flex; justify-content:space-between; align-items:flex-start; margin-bottom:1rem;">
        <div>
            <h3 style="margin:0; font-size:1.1rem; color:{COLORS['text_primary']}">{seg_name}</h3>
            <div style="font-size:0.85rem; color:{COLORS['text_secondary']}">{meta['def']}</div>
        </div>
        <div style="text-align:right;">
            <div style="font-size:1.5rem; font-weight:700; color:{COLORS['text_primary']}">{count:,}</div>
            <div style="font-size:0.8rem; color:{COLORS['text_muted']}">{pct:.0f}% of base</div>
        </div>
    </div>
    
    <div style="background:{COLORS['bg_subtle']}; padding:0.75rem; border-radius:6px; font-size:0.9rem; color:{COLORS['text_body']};">
        <strong>Strategy:</strong> {meta['strategy']}
    </div>
    
    <div style="margin-top:1rem; font-size:0.85rem; color:{COLORS['text_secondary']}; display:flex; gap:1rem;">
        <span>Total Revenue: <strong>${rev:,.0f}</strong></span>
        <span>Avg Spend: <strong>${(rev/count) if count > 0 else 0:.0f}</strong></span>
    </div>
</div>
""".replace('\n', ' '), unsafe_allow_html=True)

    st.markdown("</div>", unsafe_allow_html=True)


# =============================================================================
# TAB: RETENTION
# =============================================================================
def render_retention_tab(customer_df):
    overdue_30 = customer_df[customer_df["days_since_visit"] > 30]
    overdue_60 = customer_df[customer_df["days_since_visit"] > 60]
    overdue_90 = customer_df[customer_df["days_since_visit"] > 90]

    col1, col2, col3 = st.columns(3)

    with col1:
        st.markdown(f"""
<div class="stat-card">
    <div class="stat-label">Overdue (30+ days)</div>
    <div class="stat-value warning">{len(overdue_30)}</div>
    <div class="stat-subtext">Worth checking in</div>
</div>
""".replace('\n', ' '), unsafe_allow_html=True)

    with col2:
        st.markdown(f"""
<div class="stat-card">
    <div class="stat-label">Slipping (60+ days)</div>
    <div class="stat-value warning">{len(overdue_60)}</div>
    <div class="stat-subtext">Need attention</div>
</div>
""".replace('\n', ' '), unsafe_allow_html=True)

    with col3:
        st.markdown(f"""
<div class="stat-card">
    <div class="stat-label">At Risk (90+ days)</div>
    <div class="stat-value danger">{len(overdue_90)}</div>
    <div class="stat-subtext">May have churned</div>
</div>
""".replace('\n', ' '), unsafe_allow_html=True)

    valuable = overdue_30[overdue_30["segment"].isin(["Casual", "Regular", "Superuser"])]
    value_at_risk = valuable["total_spend"].sum() * 0.5

    st.markdown(f"""
<div class="insight-box">
    <p><strong>{len(valuable)} valuable customers</strong> are overdue.
    A quick check-in could protect <strong>${value_at_risk:,.0f}</strong> in annual revenue.</p>
</div>
""".replace('\n', ' '), unsafe_allow_html=True)

    st.markdown('<div class="section-header">Top Retention Priorities</div>', unsafe_allow_html=True)

    at_risk = overdue_30.sort_values("total_spend", ascending=False).head(8)

    if len(at_risk) > 0:
        for idx, row in at_risk.iterrows():
            days = int(row["days_since_visit"])
            spend = row["total_spend"]
            visits = int(row["frequency"])
            
            # Determine urgency color
            if days > 90:
                border_color = COLORS["danger"]
                badge_bg = "#FEF2F2"
                badge_text = COLORS["danger"]
                status = "At Risk"
            elif days > 60:
                border_color = COLORS["warning"]
                badge_bg = "#FFFBEB"
                badge_text = COLORS["warning"]
                status = "Slipping"
            else:
                border_color = COLORS["border"]
                badge_bg = "#F3F4F6"
                badge_text = COLORS["text_secondary"]
                status = "Overdue"

            c1, c2, c3 = st.columns([3, 2, 1])
            
            with c1:
                st.markdown(f"""
<div style="font-weight:600; font-size:1rem; color:{COLORS['text_primary']}">{row['client_name']}</div>
<div style="font-size:0.85rem; color:{COLORS['text_secondary']}">Last visit: {days} days ago</div>
""", unsafe_allow_html=True)
            
            with c2:
                st.markdown(f"""
<div style="display:flex; gap:1rem; align-items:center;">
    <div style="background:{badge_bg}; color:{badge_text}; font-size:0.75rem; font-weight:600; padding:0.2rem 0.6rem; border-radius:4px;">{status}</div>
    <div style="font-size:0.9rem; color:{COLORS['text_primary']}"><strong>${spend:,.0f}</strong> LTV</div>
</div>
""", unsafe_allow_html=True)
            
            with c3:
                # Mock email link - in real app would use mailto or internal messaging
                message = f"Hi {row['client_name'].split()[0]}, we missed you! Here is a special offer."
                link = build_email_link(row.get('email', ''), "We miss you", message)
                st.link_button("Contact", link)
            
            st.markdown(f"<div style='border-bottom:1px solid {COLORS['border']}; margin:0.5rem 0 1rem 0;'></div>", unsafe_allow_html=True)
            
    else:
        st.success("All customers are active! Nice work.")


# =============================================================================
# TAB: UPGRADES
# =============================================================================
def render_upgrades_tab(customer_df, business_name):
    casuals = customer_df[customer_df["segment"] == "Casual"]
    regulars = customer_df[customer_df["segment"] == "Regular"]

    avg_casual = casuals["total_spend"].mean() if len(casuals) > 0 else 0
    avg_regular = regulars["total_spend"].mean() if len(regulars) > 0 else 0
    upgrade_value = avg_regular - avg_casual if (len(casuals) > 0 and len(regulars) > 0) else 300
    if upgrade_value < 50: upgrade_value = 300 # Heuristic floor

    if "coupon_loyal" not in st.session_state:
        st.session_state.coupon_loyal = generate_coupon_code("LOYAL")

    col_strategy, col_candidates = st.columns([1, 1.2])

    with col_strategy:
        st.markdown(f'<div class="section-header">Upgrade Strategy</div>', unsafe_allow_html=True)
        
        st.markdown(f"""
<div class="card" style="padding:1.5rem;">
    <div style="margin-bottom:1rem;">
        <h3 style="margin:0; font-size:1.1rem; color:{COLORS['text_primary']}">Targeting Casuals</h3>
        <p style="font-size:0.9rem; color:{COLORS['text_secondary']}; line-height:1.4;">
            Your <strong>Casual</strong> customers visit occasionally. 
            Converting them to <strong>Regulars</strong> is your highest ROI growth lever.
        </p>
    </div>
    
    <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:1.5rem; padding-bottom:1.5rem; border-bottom:1px solid {COLORS['border']};">
        <div>
            <div style="font-size:0.8rem; color:{COLORS['text_secondary']}">Value per Upgrade</div>
            <div style="font-size:1.4rem; font-weight:700; color:{COLORS['green']}">+${upgrade_value:,.0f}</div>
            <div style="font-size:0.75rem; color:{COLORS['text_muted']}">Annual Value</div>
        </div>
            <div>
            <div style="font-size:0.8rem; color:{COLORS['text_secondary']}">Candidates</div>
            <div style="font-size:1.4rem; font-weight:700; color:{COLORS['text_primary']}">{len(casuals[casuals["frequency"] >= 5])}</div>
            <div style="font-size:0.75rem; color:{COLORS['text_muted']}">Ready to convert</div>
        </div>
    </div>
    
    <div style="font-weight:600; font-size:0.9rem; margin-bottom:0.5rem; color:{COLORS['text_primary']}">Campaign Offer Code</div>
    <div style="display:flex; gap:0.5rem; align-items:center;">
        <div class="coupon-code" style="flex:1">{st.session_state.coupon_loyal}</div>
        
    </div>
    <div style="font-size:0.8rem; color:{COLORS['text_secondary']}; margin-top:0.5rem;">
        Use this code in your next email blast to track conversions.
    </div>
</div>
""".replace('\n', ' '), unsafe_allow_html=True)
        
        if st.button("Generate New Code"):
            st.session_state.coupon_loyal = generate_coupon_code("LOYAL")
            st.rerun()

    with col_candidates:
        st.markdown(f'<div class="section-header">Top Candidates</div>', unsafe_allow_html=True)
        
        candidates = casuals[casuals["frequency"] >= 5].sort_values("frequency", ascending=False).head(5)
        
        if len(candidates) > 0:
            for idx, row in candidates.iterrows():
                visits_to_regular = 9 - int(row['frequency'])
                # Ensure positive text
                if visits_to_regular <= 0:
                    status_text = "Ready for Regular"
                    status_color = COLORS["success"]
                else:
                    status_text = f"{visits_to_regular} visits to Regular"
                    status_color = COLORS["text_secondary"]
                
                st.markdown(f"""
<div class="card" style="padding:1rem; margin-bottom:0.75rem; display:flex; justify-content:space-between; align-items:center;">
    <div>
        <div style="font-weight:600; color:{COLORS['text_primary']}">{row['client_name']}</div>
        <div style="font-size:0.85rem; color:{COLORS['text_secondary']}">
            {int(row['frequency'])} visits · ${row['total_spend']:,.0f} spend
        </div>
    </div>
    <div style="text-align:right;">
            <div style="font-size:0.8rem; font-weight:600; color:{status_color}; margin-bottom:0.25rem;">{status_text}</div>
    </div>
</div>
""".replace('\n', ' '), unsafe_allow_html=True)
                
                # We could add an "Action" button here too, but simple list is fine for now
        else:
            st.info("No casual customers with 5+ visits yet. Keep growing your base!")


# =============================================================================
# TAB: CLV
# =============================================================================
def render_clv_tab(customer_df):
    clv_results = fit_gamma_gamma(customer_df)

    if not clv_results["success"]:
        st.warning(clv_results["message"])
        return

    col1, col2, col3 = st.columns(3)

    with col1:
        st.markdown(f"""
        <div class="stat-card">
            <div class="stat-label">Average CLV</div>
            <div class="stat-value">${clv_results['avg_clv']:,.0f}</div>
            <div class="stat-subtext">Per customer</div>
        </div>
        """.replace('\n', ' '), unsafe_allow_html=True)

    with col2:
        st.markdown(f"""
        <div class="stat-card">
            <div class="stat-label">Top 10% CLV</div>
            <div class="stat-value accent">${clv_results['top_10_pct_clv']:,.0f}</div>
            <div class="stat-subtext">Your best customers</div>
        </div>
        """.replace('\n', ' '), unsafe_allow_html=True)

    with col3:
        st.markdown(f"""
        <div class="stat-card">
            <div class="stat-label">Total Predicted</div>
            <div class="stat-value success">${clv_results['total_clv']:,.0f}</div>
            <div class="stat-subtext">Future revenue</div>
        </div>
        """.replace('\n', ' '), unsafe_allow_html=True)

    multiplier = clv_results['top_10_pct_clv'] / clv_results['avg_clv'] if clv_results['avg_clv'] > 0 else 1

    st.markdown(f"""
    <div class="insight-box">
        <p>Your top 10% are worth <strong>{multiplier:.1f}x more</strong> than average.
        Focus on keeping them happy.</p>
    </div>
    """.replace('\n', ' '), unsafe_allow_html=True)

    c1, c2 = st.columns([1.5, 1])

    with c1:
        st.markdown('<div class="section-header">Value Distribution</div>', unsafe_allow_html=True)
        repeat_df = clv_results["repeat_customers"]
        
        fig = go.Figure()
        fig.add_trace(go.Histogram(
            x=repeat_df['clv'],
            nbinsx=30, 
            marker_color=COLORS["green"],
            opacity=0.8
        ))

        fig.update_layout(
            height=300,
            margin=dict(t=20, b=20, l=40, r=20),
            paper_bgcolor="rgba(0,0,0,0)",
            plot_bgcolor="rgba(0,0,0,0)",
            xaxis=dict(title="Predicted Value ($)", showgrid=False, showline=True, linecolor=COLORS["border"], tickfont=dict(color=COLORS["text_secondary"], family="Inter")),
            yaxis=dict(title="Customer Count", showgrid=True, gridcolor=COLORS["border"], showline=False, tickfont=dict(color=COLORS["text_secondary"], family="Inter")),
            font=dict(family="Inter, sans-serif")
        )
        st.plotly_chart(fig, use_container_width=True)

    with c2:
        st.markdown('<div class="section-header">Future Whales</div>', unsafe_allow_html=True)
        top_future = repeat_df.sort_values("clv", ascending=False).head(4)
        
        for idx, row in top_future.iterrows():
            st.markdown(f"""
            <div class="card" style="padding:0.8rem; margin-bottom:0.75rem;">
                <div style="font-weight:600; color:{COLORS['text_primary']}; margin-bottom:0.25rem;">{row['client_name']}</div>
                <div style="display:flex; justify-content:space-between; align-items:center;">
                    <div style="font-size:0.8rem; color:{COLORS['text_muted']}">Current: ${row['total_spend']:,.0f}</div>
                    <div style="font-weight:700; color:{COLORS['green']}; font-size:0.9rem;">+${row['clv']:,.0f} <span style="font-size:0.7rem; font-weight:400; color:{COLORS['text_secondary']}">next 12m</span></div>
                </div>
            </div>
            """.replace('\n', ' '), unsafe_allow_html=True)


# =============================================================================
# TAB: CHURN
# =============================================================================
def render_churn_tab(customer_df, business_name):
    # business_name passed in args

    churn_results = get_churn_summary(customer_df)

    col1, col2, col3 = st.columns(3)

    with col1:
        st.markdown(f"""
<div class="stat-card">
    <div class="stat-label">Likely to Churn</div>
    <div class="stat-value danger">{churn_results['high_risk_count']}</div>
    <div class="stat-subtext">High probability</div>
</div>
""".replace('\n', ' '), unsafe_allow_html=True)

    with col2:
        st.markdown(f"""
<div class="stat-card">
    <div class="stat-label">Revenue at Risk</div>
    <div class="stat-value warning">${churn_results['revenue_at_risk']:,.0f}</div>
    <div class="stat-subtext">If all churn</div>
</div>
""".replace('\n', ' '), unsafe_allow_html=True)

    with col3:
        st.markdown(f"""
<div class="stat-card">
    <div class="stat-label">Still Active</div>
    <div class="stat-value success">{churn_results['still_active_pct']:.0%}</div>
    <div class="stat-subtext">Healthy customers</div>
</div>
""".replace('\n', ' '), unsafe_allow_html=True)

    st.markdown(f"""
<div class="insight-box">
    <p><strong>{churn_results['high_risk_count']} customers</strong> are at high risk of leaving.
    Winning them back could recover <strong>${churn_results['revenue_at_risk'] * 0.3:,.0f}</strong> (assuming 30% success rate).</p>
</div>
""".replace('\n', ' '), unsafe_allow_html=True)

    c1, c2 = st.columns([1.5, 1])

    with c1:
        st.markdown('<div class="section-header">Churn Probability Map</div>', unsafe_allow_html=True)
        plot_df = churn_results["customer_df"]
        fig = go.Figure()

        low_risk = plot_df[plot_df["p_churn"] < 0.4]
        med_risk = plot_df[(plot_df["p_churn"] >= 0.4) & (plot_df["p_churn"] < 0.7)]
        high_risk_df = plot_df[plot_df["p_churn"] >= 0.7]

        fig.add_trace(go.Scatter(
            x=low_risk["days_since_visit"], y=low_risk["frequency"],
            mode='markers', name='Low risk',
            marker=dict(color=COLORS["success"], size=8, opacity=0.6),
            hovertemplate='%{customdata[0]}<br>%{x} days ago<br>%{y} visits<extra></extra>',
            customdata=low_risk[["client_name"]].values
        ))

        fig.add_trace(go.Scatter(
            x=med_risk["days_since_visit"], y=med_risk["frequency"],
            mode='markers', name='Medium risk',
            marker=dict(color=COLORS["warning"], size=10, opacity=0.7),
            hovertemplate='%{customdata[0]}<br>%{x} days ago<br>%{y} visits<extra></extra>',
            customdata=med_risk[["client_name"]].values
        ))

        fig.add_trace(go.Scatter(
            x=high_risk_df["days_since_visit"], y=high_risk_df["frequency"],
            mode='markers', name='High risk',
            marker=dict(color=COLORS["danger"], size=12, opacity=0.9, line=dict(width=1, color="white")),
            hovertemplate='%{customdata[0]}<br>%{x} days ago<br>%{y} visits<extra></extra>',
            customdata=high_risk_df[["client_name"]].values
        ))

        fig.update_layout(
            height=350,
            margin=dict(t=20, b=20, l=40, r=20),
            paper_bgcolor="rgba(0,0,0,0)",
            plot_bgcolor="rgba(0,0,0,0)",
            xaxis=dict(title="Days Since Last Visit", showgrid=True, gridcolor=COLORS["border"], showline=True, linecolor=COLORS["border"], tickfont=dict(color=COLORS["text_secondary"], family="Inter")),
            yaxis=dict(title="Number of Visits", showgrid=True, gridcolor=COLORS["border"], showline=False, tickfont=dict(color=COLORS["text_secondary"], family="Inter")),
            legend=dict(orientation="h", yanchor="bottom", y=1.02, xanchor="right", x=1, font=dict(color=COLORS["text_primary"], family="Inter")),
            font=dict(family="Inter, sans-serif", color=COLORS["text_body"])
        )
        st.plotly_chart(fig, use_container_width=True)

    with c2:
        st.markdown('<div class="section-header">Recovery Priorities</div>', unsafe_allow_html=True)
        
        if "winback_coupon" not in st.session_state:
            st.session_state.winback_coupon = generate_coupon_code("MISS")
            
        high_risk = churn_results["high_risk_customers"].sort_values("total_spend", ascending=False).head(5)
        
        if len(high_risk) > 0:
            for idx, row in high_risk.iterrows():
                churn_pct = row["p_churn"] * 100
                st.markdown(f"""
                <div class="card" style="padding:1rem; margin-bottom:0.75rem; border-left:4px solid {COLORS['danger']};">
                    <div style="display:flex; justify-content:space-between; margin-bottom:0.5rem;">
                        <div style="font-weight:600; color:{COLORS['text_primary']}">{row['client_name']}</div>
                        <div style="font-weight:700; color:{COLORS['danger']}">{churn_pct:.0f}% Risk</div>
                    </div>
                    <div style="font-size:0.85rem; color:{COLORS['text_secondary']}; margin-bottom:0.75rem;">
                        {int(row['days_since_visit'])} days ago · ${row['total_spend']:,.0f} Value
                    </div>
                    <div style="background:{COLORS['danger_bg']}; padding:0.5rem; border-radius:4px; font-size:0.8rem; text-align:center; color:{COLORS['danger']}; font-weight:600;">
                        Wait too long and they're gone.
                    </div>
                </div>
                """.replace('\n', ' '), unsafe_allow_html=True)
                
                # Link button needs to be outside HTML block
                message = generate_winback_message(row['client_name'].split()[0], st.session_state.winback_coupon, business_name)
                link = build_email_link(row.get('email', ''), f"We miss you at {business_name}!", message)
                st.link_button(f"Recover {row['client_name']}", link, type="primary")
                st.markdown("<div style='height:0.5rem'></div>", unsafe_allow_html=True)
        else:
            st.success("No high-risk customers identified!")


# =============================================================================
# MAIN
# =============================================================================
def main():
    if st.session_state.current_view == "login":
        render_login()
    elif st.session_state.current_view == "upload":
        render_upload()
    elif st.session_state.current_view == "dashboard":
        render_dashboard()
    else:
        render_login()

if __name__ == "__main__":
    main()
